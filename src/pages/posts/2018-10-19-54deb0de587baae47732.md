---
templateKey: blog-post
title: Firebase Firestore ã®ãƒ‡ãƒ¼ã‚¿ã‚’ async/await ã§å–å¾—ã™ã‚‹
date: 2018-10-19T00:00:00.000+09:00
tags:
  - Firebase
  - Kotlin
  - Android
---
**ä¸€è¡Œã¾ã¨ã‚ï¼š [kotlinx-coroutines-play-services](https://github.com/Kotlin/kotlinx.coroutines/tree/develop/integration/kotlinx-coroutines-play-services) ã‚’ä½¿ãŠã†ã­**

<!--more-->

Firebase Firestore ã® Android ç”¨ SDK ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ã§è¡Œã†ã‚ˆã†ã§ã™ã€‚

* [Cloud Firestore ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ Â /Â  Firebase](https://firebase.google.com/docs/firestore/query-data/get-data?hl=ja)

ã¾ãŸã€ã‚³ãƒ¼ãƒ‰ä¾‹ãŒ Java ã®ã¿ã§ Kotlin ã®ä¾‹ãŒãªã„ã®ã§ã€Java ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ Kotlin ã§æ›¸ãæ›ãˆãŸã‚ã¨ã€ã•ã‚‰ã« Kotlin-coroutine ã‚’ä½¿ã£ã¦ async/await åŒ–ã—ã¦ã¿ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã‚’1ä»¶å–å¾—ã™ã‚‹å ´åˆ

ã¾ãšã€å˜ä¸€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

### Java ç‰ˆ

Java ã§ã¯æ¬¡ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã«ãªã‚Šã¾ã™ã€‚

```java
DocumentReference docRef = db.collection("cities").document("SF");
docRef.get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {
    @Override
    public void onComplete(@NonNull Task<DocumentSnapshot> task) {
        if (task.isSuccessful()) {
            DocumentSnapshot document = task.getResult();
            if (document.exists()) {
                Log.d(TAG, "DocumentSnapshot data: " + document.getData());
            } else {
                Log.d(TAG, "No such document");
            }
        } else {
            Log.d(TAG, "get failed with ", task.getException());
        }
    }
});
```

### Kotlin ç‰ˆ

```kotlin
val docRef = db.collection("cities").document("SF")
docRef.get().addOnCompleteListener { task ->
    if (task.isSuccessful()) {
        val document = task.getResult()
        if (document.exists()) {
            Log.d(TAG, "DocumentSnapshot data: " + document.data)
        } else {
            Log.d(TAG, "No such document")
        }
    } else {
        Log.d(TAG, "get failed with ", task.getException())
    }
}
```

å°‘ã—ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸã€‚

## Kotlin + async/awaitç‰ˆ

ã•ã¦ã€ã“ã“ã‹ã‚‰ãŒæœ¬é¡Œã§ã€async/await ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
æ³¨ç›®ã—ãŸã„ã®ãŒã€ ``docRef.get()`` ã®æˆ»ã‚Šå€¤ã®å‹ã§ã€ã“ã‚Œã¯ ``Task<T>`` ã§ã™ã€‚
``Task<T>`` ã«ã€ ``addOnCompleteListener`` ã‚„ãã®ä»–è«¸ã€…ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã€çµæœã¯ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å—ã‘å–ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã“ã¨ã¯ã€ã“ã® ``Task<T>`` ã‚’ async/await ã§ä½¿ãˆã‚‹å½¢å¼ã«å¤‰æ›ã—ã¦ã‚ã’ã‚Œã°ã‚ˆã„ã‚ã‘ã§ã™ã€‚

ãã“ã§ã€ã“ã‚“ãªæ‹¡å¼µé–¢æ•°ã‚’ä½œã£ã¦ã‚ã’ã¾ã™ã€‚

```kotlin
suspend fun <T> Task<T>.toSuspendable(): T {
    return suspendCoroutine { cont ->
        this.addOnCompleteListener { task ->
            if (task.isSuccessful) {
                cont.resume(task.result)
            } else if (task.isCanceled) {
                cont.resumeWithException(CancellationException())
            } else {
                cont.resumeWithException(task.exception ?: Exception("Unknown"))
            }
        }
    }
}
```

Kotlin ã§ async/await = æ‰€è¬‚ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«å¯¾å¿œã•ã›ã‚‹ã«ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã« ``suspend`` ã‚’ä»˜ã‘ã¾ã™ã€‚ãã—ã¦ã€``suspendCoroutine`` ã‚’å‘¼ã³å‡ºã™ã¨ã€ãã“ã§å®Ÿè¡Œã‚’ã€Œä¸€æ™‚åœæ­¢ã€ã—ã€``cont.resume`` ã¾ãŸã¯ ``cont.resumeWithException`` ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã‚‰å†é–‹ã—ã¾ã™ã€‚ã“ã“ã§ã¯ ``addOnCompleteListener`` ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å—ä¿¡ã—ãŸã¨ãã« ``cont.resume`` ã‚’å‘¼ã³å‡ºã—ã¦ã€å‡¦ç†ã‚’å†é–‹ã•ã›ã¦ã„ã¾ã™ã€‚

ã•ã¦ã€å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```kotlin
launch(CommonPool) {
    val document = docRef.get().toSuspendable()
    if (document.exists()) {
        Log.d(TAG, "DocumentSnapshot data: " + document.data)
    } else {
        Log.d(TAG, "No such document")
    }
}
```

ã¯ã„ã€‚
æœ€åˆã® Java ã®ã‚³ãƒ¼ãƒ‰ã«æ¯”ã¹ã‚‹ã¨ãšã„ã¶ã‚“ã‚¹ãƒƒã‚­ãƒªã—ãŸã¨æ€ã„ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°å–å¾—ã™ã‚‹å ´åˆ

ä½œæˆã—ãŸæ‹¡å¼µé–¢æ•° ``Task.toSuspendable`` ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ä»¶å–å¾—ã™ã‚‹ã¨ãã«ã‚‚ä½¿ãˆã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã® Java ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã€

```java
db.collection("cities")
        .whereEqualTo("capital", true)
        .get()
        .addOnCompleteListener(new OnCompleteListener<QuerySnapshot>() {
            @Override
            public void onComplete(@NonNull Task<QuerySnapshot> task) {
                if (task.isSuccessful()) {
                    for (QueryDocumentSnapshot document : task.getResult()) {
                        Log.d(TAG, document.getId() + " => " + document.getData());
                    }
                } else {
                    Log.d(TAG, "Error getting documents: ", task.getException());
                }
            }
        });
```

ã“ã‚Œã‚’ã€ä¸€æ°—ã« Kotlin + async/await åŒ–ã—ã¦ã¿ã¾ã™ã€‚

```kotlin
launch(CommonPool) {
    val querySnapshot =  db.collection("cities")
        .whereEqualTo("capital", true)
        .get().toSuspendable()
    for (document in querySnapshot) {
        Log.d(TAG, document.id + " => " + document.data)
    }
}
```

è¤‡æ•°ä»¶ã‚’å–å¾—ã™ã‚‹ ``db.collection("cities").whereXXX(...).get()`` ã®æˆ»ã‚Šå€¤ã‚‚ ``Task<T>`` ãªã®ã§ ``toSuspendable`` ãŒä½¿ãˆã¾ã™ã€‚
ãŸã ã—ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã® ``T`` ã¯ ``QuerySnapshot`` å‹ã§ã™ã€‚
``QuerySnapshot`` ã¯ãã‚Œè‡ªä½“ãŒè¤‡æ•°ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€ ``for`` ã§èµ°æŸ»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã¾ã¨ã‚

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ã®å‹ã‚’ suspend å¯èƒ½ãªé–¢æ•°ã«å¤‰æ›ã™ã‚‹æ‹¡å¼µé–¢æ•°ã‚’ä½œã£ã¦ãŠãã¨ã€ã‚¹ãƒƒã‚­ãƒªã¨æ›¸ã‘ã¾ã™ã€‚

ã‚‚ã—ã‹ã—ãŸã‚‰æ—¢ã«Firebase SDKã«æ­è¼‰ã•ã‚Œã¦ã„ãŸã‚Šã€æœ‰å¿—ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å®Ÿç¾ã§ãã‚‹ã®ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ãŒã€è‡ªä½œã§ã‚‚ã©ã†ã«ã‹ãªã‚Šã¾ã™ã‚ˆã€ã¨ã„ã†ãŠè©±ã§ã—ãŸã€‚

<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">æœ€å¾Œã«æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã§ã™ãŒkotlinx-coroutines-play-servicesã§ã„ã‘ã¾ã™ã­ğŸ‘€ ãŸã ã“ã†ã‚„ã£ã¦æ‹¡å¼µã¯ã‚„ã—ã¦å¯¾å¿œã—ã¦ã„ã‘ã‚‹ã®ã¯ã„ã„ã§ã™ã­ğŸ‘ <a href="https://t.co/eSHYXtEWaP">https://t.co/eSHYXtEWaP</a></p>&mdash; takahirom (@new_runnable) <a href="https://twitter.com/new_runnable/status/1053208499193241601?ref_src=twsrc%5Etfw">2018å¹´10æœˆ19æ—¥</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ã‚„ã£ã±ã‚Šã‚ã£ãŸãƒ¼ï¼ww
è‡ªä½œã® ``.toSuspendable()`` ã¯ã€kotlinx-coroutines-play-services ã‚’å°å…¥ã—ãŸã‚‰ ``.await()`` ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã£ã¡ã®æ–¹ãŒ cancellable ã ã—å®Œäº†ã—ã¦ã‚‹å ´åˆã®è€ƒæ…®ã‚‚ã•ã‚Œã‚Œã¦ã‚ˆã„ã§ã™ã­ :thumbsup: 

å°å…¥æ–¹æ³•ã¯ã‚¢ãƒ—ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® ``build.gradle`` ã« ``kotlinx-coroutines-play-services`` ã‚’è¿½åŠ ã€ã§ã™ã€‚

```
def coroutines_version = '0.30.2'
implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutines_version"
implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$coroutines_version"
implementation "org.jetbrains.kotlinx:kotlinx-coroutines-play-services:$coroutines_version"  â†è¿½åŠ 
```
